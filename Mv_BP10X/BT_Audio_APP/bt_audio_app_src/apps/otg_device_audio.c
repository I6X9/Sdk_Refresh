/**
 *****************************************************************************
 * @file     otg_device_audio.c
 * @author   Owen
 * @version  V1.0.0
 * @date     7-September-2015
 * @brief    device audio module driver interface
 *****************************************************************************
 * @attention
 *
 * <h2><center>&copy; COPYRIGHT 2013 MVSilicon </center></h2>
 */

#include <string.h>
#include "type.h"
#include "otg_device_hcd.h"
#include "debug.h"
#include "otg_device_standard_request.h"
#include "audio_adc.h"
#include "dac.h"
#include "clk.h"
#include "adc_interface.h"
#include "dac_interface.h"
#include "mcu_circular_buf.h"
#include "otg_device_audio.h"

#ifdef CFG_APP_CONFIG
#include "resampler.h"
#include "app_config.h"
#include "audio_core_api.h"
#endif

#ifdef CFG_APP_USB_AUDIO_MODE_EN
#define AUDIO_MAX_VOLUME	999

extern MCU_CIRCULAR_CONTEXT SpeakerCircularBuf;
extern uint8_t Setup[];
extern uint8_t Request[];
	
UsbAudioSpeaker_ UsbAudioSpeaker;
UsbAudioSpeaker_ UsbAudioMic;



uint8_t iso_dac_buf[288];//bkd
uint8_t iso_adc_buf[256];

#ifdef CFG_APP_CONFIG
uint32_t UsbAudioSampleRate = CFG_PARA_SAMPLE_RATE;
uint32_t UsbAudioMicSampleRate = CFG_PARA_SAMPLE_RATE;

#ifdef CFG_FUNC_MIXER_SRC_EN
ResamplerContext*	ResamplerCt1;
int16_t* SRCOutBuf11;
#endif
#endif

extern void OTG_DeviceSendResp(uint16_t Resp, uint8_t n);
extern uint8_t UsbAudioSourceNum(void);
#if 0 // 正弦波 测试数据 和丢数据程序  	44K
const unsigned char zx_data[1764] =
{
	0x16, 0xFF, 0x16, 0xFF, 0x34, 0x08, 0x34, 0x08, 0x28, 0x11, 0x27, 0x11, 0xC2, 0x19, 0xC2, 0x19, 
	0xD8, 0x21, 0xD6, 0x21, 0x3C, 0x29, 0x3D, 0x29, 0xCC, 0x2F, 0xCB, 0x2F, 0x63, 0x35, 0x62, 0x35, 
	0xE5, 0x39, 0xE6, 0x39, 0x3C, 0x3D, 0x3B, 0x3D, 0x54, 0x3F, 0x54, 0x3F, 0x24, 0x40, 0x24, 0x40, 
	0xA7, 0x3F, 0xA8, 0x3F, 0xE0, 0x3D, 0xE0, 0x3D, 0xD8, 0x3A, 0xD8, 0x3A, 0x9E, 0x36, 0x9F, 0x36, 
	0x4A, 0x31, 0x4A, 0x31, 0xF6, 0x2A, 0xF5, 0x2A, 0xC3, 0x23, 0xC2, 0x23, 0xD5, 0x1B, 0xD6, 0x1B, 
	0x58, 0x13, 0x58, 0x13, 0x76, 0x0A, 0x76, 0x0A, 0x60, 0x01, 0x5F, 0x01, 0x40, 0xF8, 0x40, 0xF8, 
	0x49, 0xEF, 0x4A, 0xEF, 0xAA, 0xE6, 0xA9, 0xE6, 0x8D, 0xDE, 0x8D, 0xDE, 0x1D, 0xD7, 0x1E, 0xD7, 
	0x84, 0xD0, 0x83, 0xD0, 0xDF, 0xCA, 0xDE, 0xCA, 0x4D, 0xC6, 0x4D, 0xC6, 0xE8, 0xC2, 0xE8, 0xC2, 
	0xBF, 0xC0, 0xBE, 0xC0, 0xDE, 0xBF, 0xDE, 0xBF, 0x4B, 0xC0, 0x4A, 0xC0, 0x02, 0xC2, 0x01, 0xC2, 
	0xFA, 0xC4, 0xFA, 0xC4, 0x25, 0xC9, 0x24, 0xC9, 0x6B, 0xCE, 0x6C, 0xCE, 0xB4, 0xD4, 0xB4, 0xD4, 
	0xDD, 0xDB, 0xDE, 0xDB, 0xC2, 0xE3, 0xC1, 0xE3, 0x39, 0xEC, 0x39, 0xEC, 0x16, 0xF5, 0x16, 0xF5, 
	0x2B, 0xFE, 0x2B, 0xFE, 0x4B, 0x07, 0x4C, 0x07, 0x46, 0x10, 0x45, 0x10, 0xEC, 0x18, 0xEB, 0x18, 
	0x0F, 0x21, 0x0F, 0x21, 0x88, 0x28, 0x88, 0x28, 0x2E, 0x2F, 0x2F, 0x2F, 0xE0, 0x34, 0xE0, 0x34, 
	0x7E, 0x39, 0x7F, 0x39, 0xF4, 0x3C, 0xF4, 0x3C, 0x2D, 0x3F, 0x2D, 0x3F, 0x1E, 0x40, 0x1E, 0x40, 
	0xC3, 0x3F, 0xC2, 0x3F, 0x1D, 0x3E, 0x1C, 0x3E, 0x34, 0x3B, 0x34, 0x3B, 0x18, 0x37, 0x17, 0x37, 
	0xDF, 0x31, 0xDE, 0x31, 0xA3, 0x2B, 0xA2, 0x2B, 0x84, 0x24, 0x84, 0x24, 0xA7, 0x1C, 0xA7, 0x1C, 
	0x37, 0x14, 0x37, 0x14, 0x5D, 0x0B, 0x5D, 0x0B, 0x49, 0x02, 0x49, 0x02, 0x29, 0xF9, 0x29, 0xF9, 
	0x2B, 0xF0, 0x2C, 0xF0, 0x81, 0xE7, 0x81, 0xE7, 0x56, 0xDF, 0x55, 0xDF, 0xD4, 0xD7, 0xD3, 0xD7, 
	0x22, 0xD1, 0x22, 0xD1, 0x63, 0xCB, 0x62, 0xCB, 0xB6, 0xC6, 0xB6, 0xC6, 0x31, 0xC3, 0x31, 0xC3, 
	0xE8, 0xC0, 0xE8, 0xC0, 0xE6, 0xBF, 0xE7, 0xBF, 0x31, 0xC0, 0x30, 0xC0, 0xC6, 0xC1, 0xC7, 0xC1, 
	0xA1, 0xC4, 0xA0, 0xC4, 0xAD, 0xC8, 0xAD, 0xC8, 0xD8, 0xCD, 0xD9, 0xCD, 0x08, 0xD4, 0x08, 0xD4, 
	0x1D, 0xDB, 0x1C, 0xDB, 0xF0, 0xE2, 0xEF, 0xE2, 0x5A, 0xEB, 0x5A, 0xEB, 0x30, 0xF4, 0x2F, 0xF4, 
	0x41, 0xFD, 0x43, 0xFD, 0x63, 0x06, 0x63, 0x06, 0x63, 0x0F, 0x63, 0x0F, 0x13, 0x18, 0x12, 0x18, 
	0x45, 0x20, 0x45, 0x20, 0xD1, 0x27, 0xD2, 0x27, 0x8E, 0x2E, 0x8F, 0x2E, 0x5A, 0x34, 0x5A, 0x34, 
	0x17, 0x39, 0x16, 0x39, 0xAA, 0x3C, 0xA9, 0x3C, 0x03, 0x3F, 0x03, 0x3F, 0x15, 0x40, 0x15, 0x40, 
	0xDA, 0x3F, 0xDA, 0x3F, 0x55, 0x3E, 0x55, 0x3E, 0x8C, 0x3B, 0x8C, 0x3B, 0x8E, 0x37, 0x8D, 0x37, 
	0x70, 0x32, 0x70, 0x32, 0x4D, 0x2C, 0x4C, 0x2C, 0x42, 0x25, 0x43, 0x25, 0x78, 0x1D, 0x79, 0x1D, 
	0x14, 0x15, 0x14, 0x15, 0x43, 0x0C, 0x43, 0x0C, 0x33, 0x03, 0x32, 0x03, 0x12, 0xFA, 0x11, 0xFA, 
	0x0E, 0xF1, 0x0F, 0xF1, 0x5A, 0xE8, 0x5A, 0xE8, 0x20, 0xE0, 0x20, 0xE0, 0x8B, 0xD8, 0x8A, 0xD8, 
	0xC2, 0xD1, 0xC2, 0xD1, 0xEB, 0xCB, 0xEA, 0xCB, 0x20, 0xC7, 0x20, 0xC7, 0x7C, 0xC3, 0x7D, 0xC3, 
	0x14, 0xC1, 0x14, 0xC1, 0xF0, 0xBF, 0xF1, 0xBF, 0x1B, 0xC0, 0x1B, 0xC0, 0x8F, 0xC1, 0x90, 0xC1, 
	0x49, 0xC4, 0x49, 0xC4, 0x38, 0xC8, 0x38, 0xC8, 0x48, 0xCD, 0x47, 0xCD, 0x60, 0xD3, 0x60, 0xD3, 
	0x5E, 0xDA, 0x5E, 0xDA, 0x20, 0xE2, 0x20, 0xE2, 0x7E, 0xEA, 0x7D, 0xEA, 0x4A, 0xF3, 0x4A, 0xF3, 
	0x59, 0xFC, 0x59, 0xFC, 0x7A, 0x05, 0x7A, 0x05, 0x7F, 0x0E, 0x7F, 0x0E, 0x39, 0x17, 0x39, 0x17, 
	0x7A, 0x1F, 0x7C, 0x1F, 0x19, 0x27, 0x19, 0x27, 0xEC, 0x2D, 0xED, 0x2D, 0xD1, 0x33, 0xD2, 0x33, 
	0xAA, 0x38, 0xA9, 0x38, 0x5B, 0x3C, 0x5C, 0x3C, 0xD5, 0x3E, 0xD5, 0x3E, 0x09, 0x40, 0x08, 0x40, 
	0xEF, 0x3F, 0xF0, 0x3F, 0x8A, 0x3E, 0x8B, 0x3E, 0xE2, 0x3B, 0xE1, 0x3B, 0x01, 0x38, 0x02, 0x38, 
	0xFF, 0x32, 0xFF, 0x32, 0xF4, 0x2C, 0xF4, 0x2C, 0x00, 0x26, 0x01, 0x26, 0x48, 0x1E, 0x47, 0x1E, 
	0xF1, 0x15, 0xF0, 0x15, 0x29, 0x0D, 0x29, 0x0D, 0x1C, 0x04, 0x1C, 0x04, 0xFA, 0xFA, 0xFA, 0xFA, 
	0xF3, 0xF1, 0xF3, 0xF1, 0x34, 0xE9, 0x34, 0xE9, 0xEC, 0xE0, 0xEB, 0xE0, 0x44, 0xD9, 0x44, 0xD9, 
	0x66, 0xD2, 0x66, 0xD2, 0x74, 0xCC, 0x74, 0xCC, 0x8D, 0xC7, 0x8D, 0xC7, 0xCD, 0xC3, 0xCC, 0xC3, 
	0x43, 0xC1, 0x44, 0xC1, 0x00, 0xC0, 0x00, 0xC0, 0x08, 0xC0, 0x08, 0xC0, 0x5C, 0xC1, 0x5C, 0xC1, 
	0xF4, 0xC3, 0xF5, 0xC3, 0xC5, 0xC7, 0xC6, 0xC7, 0xBA, 0xCC, 0xBA, 0xCC, 0xB8, 0xD2, 0xB8, 0xD2, 
	0xA2, 0xD9, 0xA2, 0xD9, 0x52, 0xE1, 0x52, 0xE1, 0xA1, 0xE9, 0xA1, 0xE9, 0x64, 0xF2, 0x64, 0xF2, 
	0x6F, 0xFB, 0x6F, 0xFB, 0x91, 0x04, 0x91, 0x04, 0x9B, 0x0D, 0x9B, 0x0D, 0x5F, 0x16, 0x5F, 0x16, 
	0xAE, 0x1E, 0xAE, 0x1E, 0x5E, 0x26, 0x5E, 0x26, 0x48, 0x2D, 0x48, 0x2D, 0x46, 0x33, 0x45, 0x33, 
	0x3A, 0x38, 0x3A, 0x38, 0x0B, 0x3C, 0x0B, 0x3C, 0xA3, 0x3E, 0xA4, 0x3E, 0xF8, 0x3F, 0xF9, 0x3F, 
	0x01, 0x40, 0x00, 0x40, 0xBD, 0x3E, 0xBD, 0x3E, 0x34, 0x3C, 0x34, 0x3C, 0x72, 0x38, 0x73, 0x38, 
	0x8C, 0x33, 0x8C, 0x33, 0x9B, 0x2D, 0x9A, 0x2D, 0xBC, 0x26, 0xBD, 0x26, 0x14, 0x1F, 0x14, 0x1F, 
	0xCC, 0x16, 0xCC, 0x16, 0x0D, 0x0E, 0x0E, 0x0E, 0x05, 0x05, 0x06, 0x05, 0xE4, 0xFB, 0xE4, 0xFB, 
	0xD8, 0xF2, 0xD8, 0xF2, 0x0F, 0xEA, 0x10, 0xEA, 0xB9, 0xE1, 0xB9, 0xE1, 0xFF, 0xD9, 0x00, 0xDA, 
	0x0C, 0xD3, 0x0C, 0xD3, 0x01, 0xCD, 0x02, 0xCD, 0xFE, 0xC7, 0xFE, 0xC7, 0x1E, 0xC4, 0x1E, 0xC4, 
	0x75, 0xC1, 0x76, 0xC1, 0x11, 0xC0, 0x11, 0xC0, 0xF7, 0xBF, 0xF7, 0xBF, 0x2B, 0xC1, 0x2C, 0xC1, 
	0xA4, 0xC3, 0xA4, 0xC3, 0x56, 0xC7, 0x57, 0xC7, 0x2F, 0xCC, 0x2F, 0xCC, 0x14, 0xD2, 0x14, 0xD2, 
	0xE7, 0xD8, 0xE7, 0xD8, 0x86, 0xE0, 0x85, 0xE0, 0xC7, 0xE8, 0xC7, 0xE8, 0x80, 0xF1, 0x80, 0xF1, 
	0x85, 0xFA, 0x86, 0xFA, 0xA7, 0x03, 0xA7, 0x03, 0xB6, 0x0C, 0xB6, 0x0C, 0x83, 0x15, 0x83, 0x15, 
	0xE0, 0x1D, 0xE0, 0x1D, 0xA2, 0x25, 0xA2, 0x25, 0xA1, 0x2C, 0xA2, 0x2C, 0xB8, 0x32, 0xB9, 0x32, 
	0xC8, 0x37, 0xC8, 0x37, 0xB7, 0x3B, 0xB7, 0x3B, 0x70, 0x3E, 0x70, 0x3E, 0xE5, 0x3F, 0xE5, 0x3F, 
	0x0F, 0x40, 0x0F, 0x40, 0xED, 0x3E, 0xEC, 0x3E, 0x84, 0x3C, 0x82, 0x3C, 0xE1, 0x38, 0xDF, 0x38, 
	0x15, 0x34, 0x16, 0x34, 0x3D, 0x2E, 0x3D, 0x2E, 0x76, 0x27, 0x75, 0x27, 0xE0, 0x1F, 0xE0, 0x1F, 
	0xA7, 0x17, 0xA7, 0x17, 0xF1, 0x0E, 0xF1, 0x0E, 0xEE, 0x05, 0xEF, 0x05, 0xCE, 0xFC, 0xCE, 0xFC, 
	0xBC, 0xF3, 0xBC, 0xF3, 0xEC, 0xEA, 0xEB, 0xEA, 0x88, 0xE2, 0x87, 0xE2, 0xBE, 0xDA, 0xBD, 0xDA, 
	0xB3, 0xD3, 0xB3, 0xD3, 0x8F, 0xCD, 0x90, 0xCD, 0x72, 0xC8, 0x71, 0xC8, 0x73, 0xC4, 0x74, 0xC4, 
	0xAC, 0xC1, 0xAB, 0xC1, 0x25, 0xC0, 0x26, 0xC0, 0xEC, 0xBF, 0xEB, 0xBF, 0xFE, 0xC0, 0xFD, 0xC0, 
	0x57, 0xC3, 0x56, 0xC3, 0xEA, 0xC6, 0xE9, 0xC6, 0xA6, 0xCB, 0xA5, 0xCB, 0x71, 0xD1, 0x71, 0xD1, 
	0x2F, 0xD8, 0x2F, 0xD8, 0xBA, 0xDF, 0xBA, 0xDF, 0xED, 0xE7, 0xED, 0xE7, 0x9E, 0xF0, 0x9D, 0xF0, 
	0x9D, 0xF9, 0x9D, 0xF9, 0xBE, 0x02, 0xBE, 0x02, 0xD0, 0x0B, 0xD0, 0x0B, 0xA6, 0x14, 0xA6, 0x14, 
	0x0F, 0x1D, 0x11, 0x1D, 0xE3, 0x24, 0xE3, 0x24, 0xF7, 0x2B, 0xF8, 0x2B, 0x27, 0x32, 0x27, 0x32, 
	0x53, 0x37, 0x54, 0x37, 0x60, 0x3B, 0x60, 0x3B, 0x39, 0x3E, 0x39, 0x3E, 0xCF, 0x3F, 0xCE, 0x3F, 
	0x19, 0x40, 0x1A, 0x40, 0x18, 0x3F, 0x18, 0x3F, 0xCF, 0x3C, 0xD0, 0x3C, 0x4B, 0x39, 0x4B, 0x39, 
	0x9D, 0x34, 0x9D, 0x34, 0xDF, 0x2E, 0xDE, 0x2E, 0x2D, 0x28, 0x2D, 0x28, 0xAB, 0x20, 0xAB, 0x20, 
	0x7F, 0x18, 0x7F, 0x18, 0xD5, 0x0F, 0xD4, 0x0F, 0xD7, 0x06, 0xD7, 0x06, 0xB8, 0xFD, 0xB7, 0xFD, 
	0xA2, 0xF4, 0xA2, 0xF4, 0xC9, 0xEB, 0xCA, 0xEB, 0x59, 0xE3, 0x59, 0xE3, 0x7C, 0xDB, 0x7C, 0xDB, 
	0x5D, 0xD4, 0x5D, 0xD4, 0x22, 0xCE, 0x22, 0xCE, 0xE8, 0xC8, 0xE8, 0xC8, 0xCD, 0xC4, 0xCD, 0xC4, 
	0xE4, 0xC1, 0xE4, 0xC1, 0x3D, 0xC0, 0x3D, 0xC0, 0xE2, 0xBF, 0xE2, 0xBF, 0xD3, 0xC0, 0xD3, 0xC0, 
	0x0C, 0xC3, 0x0C, 0xC3, 0x81, 0xC6, 0x80, 0xC6, 0x20, 0xCB, 0x20, 0xCB, 0xD2, 0xD0, 0xD1, 0xD0, 
	0x78, 0xD7, 0x78, 0xD7, 0xF1, 0xDE, 0xF1, 0xDE, 0x15, 0xE7, 0x15, 0xE7, 0xBA, 0xEF, 0xBA, 0xEF, 
	0xB4, 0xF8, 0xB4, 0xF8, 0xD3, 0x01, 0xD4, 0x01, 0xEB, 0x0A, 0xEA, 0x0A, 0xC8, 0x13, 0xC7, 0x13, 
	0x3F, 0x1C, 0x3F, 0x1C, 0x23, 0x24, 0x23, 0x24, 0x4C, 0x2B, 0x4C, 0x2B, 0x94, 0x31, 0x94, 0x31, 
	0xDC, 0x36, 0xDC, 0x36, 0x06, 0x3B, 0x07, 0x3B, 0xFE, 0x3D, 0xFE, 0x3D, 0xB5, 0x3F, 0xB5, 0x3F, 
	0x21, 0x40, 0x21, 0x40, 0x40, 0x3F, 0x41, 0x3F, 0x19, 0x3D, 0x18, 0x3D, 0xB3, 0x39, 0xB2, 0x39, 
	0x21, 0x35, 0x21, 0x35, 0x7D, 0x2F, 0x7D, 0x2F, 0xE3, 0x28, 0xE2, 0x28, 0x72, 0x21, 0x73, 0x21, 
	0x57, 0x19, 0x57, 0x19, 0xB7, 0x10, 0xB7, 0x10, 0xC0, 0x07, 0xC0, 0x07, 0xA1, 0xFE, 0xA1, 0xFE, 
	0x8A, 0xF5, 0x89, 0xF5, 0xA7, 0xEC, 0xA7, 0xEC, 0x2B, 0xE4, 0x2B, 0xE4, 0x3E, 0xDC, 0x3F, 0xDC, 
	0x0A, 0xD5, 0x0B, 0xD5, 0xB6, 0xCE, 0xB7, 0xCE, 0x61, 0xC9, 0x61, 0xC9, 0x28, 0xC5, 0x29, 0xC5, 
	0x21, 0xC2, 0x20, 0xC2, 0x59, 0xC0, 0x59, 0xC0, 0xDC, 0xBF, 0xDC, 0xBF, 0xAC, 0xC0, 0xAC, 0xC0, 
	0xC4, 0xC2, 0xC4, 0xC2, 0x1B, 0xC6, 0x1B, 0xC6, 0x9D, 0xCA, 0x9D, 0xCA, 0x34, 0xD0, 0x34, 0xD0, 
	0xC4, 0xD6, 0xC3, 0xD6, 0x29, 0xDE, 0x29, 0xDE, 0x3D, 0xE6, 0x3E, 0xE6, 0xD9, 0xEE, 0xD8, 0xEE, 
	0xCC, 0xF7, 0xCC, 0xF7, 0xEA, 0x00, 0xEA, 0x00, 0x03, 0x0A, 0x04, 0x0A, 0xE9, 0x12, 0xE9, 0x12, 
	0x6B, 0x1B, 0x6C, 0x1B, 0x61, 0x23, 0x61, 0x23, 0x9E, 0x2A, 0x9F, 0x2A, 0xFF, 0x30, 0xFF, 0x30, 
	0x61, 0x36, 0x60, 0x36, 0xA9, 0x3A, 0xA9, 0x3A, 0xC0, 0x3D, 0xC1, 0x3D, 0x97, 0x3F, 0x99, 0x3F, 
	0x26, 0x40, 0x25, 0x40, 0x66, 0x3F, 0x67, 0x3F, 0x5E, 0x3D, 0x5E, 0x3D, 0x17, 0x3A, 0x18, 0x3A, 
	0xA3, 0x35, 0xA3, 0x35, 0x19, 0x30, 0x1A, 0x30, 0x95, 0x29, 0x96, 0x29, 0x3A, 0x22, 0x3A, 0x22, 
	0x2D, 0x1A, 0x2C, 0x1A, 0x98, 0x11, 0x98, 0x11, 0xA8, 0x08, 0xA8, 0x08, 0x8B, 0xFF, 0x8B, 0xFF, 
	0x70, 0xF6, 0x71, 0xF6, 0x87, 0xED, 0x87, 0xED, 0xFE, 0xE4, 0xFE, 0xE4, 0x01, 0xDD, 0x01, 0xDD, 
	0xBA, 0xD5, 0xBA, 0xD5, 0x4E, 0xCF, 0x4D, 0xCF, 0xDD, 0xC9, 0xDE, 0xC9, 0x87, 0xC5, 0x87, 0xC5, 
	0x5F, 0xC2, 0x5F, 0xC2, 0x78, 0xC0, 0x78, 0xC0, 0xDA, 0xBF, 0xD9, 0xBF, 0x89, 0xC0, 0x89, 0xC0, 
	0x80, 0xC2, 0x80, 0xC2, 0xB7, 0xC5, 0xB8, 0xC5, 0x1D, 0xCA, 0x1D, 0xCA, 0x99, 0xCF, 0x99, 0xCF, 
	0x12, 0xD6, 0x12, 0xD6, 0x63, 0xDD, 0x63, 0xDD, 0x69, 0xE5, 0x69, 0xE5, 0xF8, 0xED, 0xF7, 0xED, 
	0xE4, 0xF6, 0xE4, 0xF6, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x09, 0x1C, 0x09, 0x08, 0x12, 0x08, 0x12, 
	0x97, 0x1A, 0x98, 0x1A, 0x9D, 0x22, 0x9D, 0x22, 0xEE, 0x29, 0xEE, 0x29, 0x66, 0x30, 0x66, 0x30, 
	0xE3, 0x35, 0xE4, 0x35, 0x48, 0x3A, 0x49, 0x3A, 0x80, 0x3D, 0x80, 0x3D, 0x78, 0x3F, 0x77, 0x3F, 
	0x27, 0x40, 0x27, 0x40, 0x88, 0x3F, 0x88, 0x3F, 0xA1, 0x3D, 0xA1, 0x3D, 0x79, 0x3A, 0x79, 0x3A, 
	0x23, 0x36, 0x22, 0x36, 0xB3, 0x30, 0xB3, 0x30, 0x47, 0x2A, 0x46, 0x2A, 0xFE, 0x22, 0xFE, 0x22, 
	0x02, 0x1B, 0x02, 0x1B, 0x79, 0x12, 0x79, 0x12, 0x8F, 0x09, 0x90, 0x09, 0x75, 0x00, 0x75, 0x00, 
	0x57, 0xF7, 0x58, 0xF7, 0x68, 0xEE, 0x68, 0xEE, 0xD3, 0xE5, 0xD3, 0xE5, 0xC6, 0xDD, 0xC6, 0xDD, 
	0x6B, 0xD6, 0x6B, 0xD6, 0xE7, 0xCF, 0xE7, 0xCF, 0x5C, 0xCA, 0x5D, 0xCA, 0xE8, 0xC5, 0xE9, 0xC5, 
	0xA2, 0xC2, 0xA2, 0xC2, 0x9A, 0xC0, 0x99, 0xC0, 0xDA, 0xBF, 0xDB, 0xBF, 0x68, 0xC0, 0x69, 0xC0, 
	0x40, 0xC2, 0x3F, 0xC2, 0x57, 0xC5, 0x57, 0xC5, 0x9F, 0xC9, 0x9F, 0xC9, 0x01, 0xCF, 0x01, 0xCF, 
	0x62, 0xD5, 0x62, 0xD5, 0x9F, 0xDC, 0x9F, 0xDC, 0x94, 0xE4, 0x94, 0xE4, 0x18, 0xED, 0x17, 0xED, 
	0xFC, 0xF5, 0xFC, 0xF5
};

#if 0
uint32_t iso_count=0;

	if(iso_count == 9)
	{
		memcpy(iso_dac_buf,zx_data+176*iso_count,180);//1 MS
		iso_count = 0;
		Len=180;
	}
	else
	{
		memcpy(iso_dac_buf,zx_data+176*iso_count,176);// 1*9 MS
		Len=176;
	}
	iso_count++;
#endif

#endif
/**
 * @brief  USB声卡模式下，发送反向控制命令
 * @param  Cmd 反向控制命令
 * @return 1-成功，0-失败
 */
#define AUDIO_STOP        BIT(7) 
#define AUDIO_PP          BIT(6) 

#define AUDIO_MUTE        BIT(4)

#define AUDIO_NEXT        BIT(2) 
#define AUDIO_PREV        BIT(3) 

#define AUDIO_VOL_UP      BIT(0) 
#define AUDIO_VOL_DN      BIT(1)

/////////////////////////
void PCAudioStop(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_STOP);
}
void PCAudioPP(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_PP);
}
void PCAudioNext(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_NEXT);
}
void PCAudioPrev(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_PREV);
}

void PCAudioVolUp(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_VOL_UP);
}

void PCAudioVolDn(void)
{
	OTG_DeviceAudioSendPcCmd(AUDIO_VOL_DN);
}

bool OTG_DeviceAudioSendPcCmd(uint8_t Cmd)
{
	OTG_DeviceInterruptSend(0x01,&Cmd, 1,1000);
	Cmd = 0;
	OTG_DeviceInterruptSend(0x01,&Cmd, 1,1000);
	return TRUE;
}

//转采样直接在中断中处理，转采样时间大约是180us。
//注意一下需要4字节对齐
void OnDeviceAudioRcvIsoPacket(void)
{

#ifdef CFG_FUNC_MIXER_SRC_EN
	int32_t SRCDoneLen; 			//SRC之后存放于outbuf的数据长度
	//int32_t MaxLen = MAX_FRAME_SAMPLES;
#endif
	uint32_t Len;
	OTG_DeviceISOReceive(DEVICE_ISO_OUT_EP, iso_dac_buf, 288, &Len);

#ifndef CFG_APP_CONFIG
	AudioDAC_DataSet(DAC0, iso_dac_buf, Len/4);
#else


#ifdef CFG_FUNC_MIXER_SRC_EN
	if(UsbAudioSampleRate != CFG_PARA_SAMPLE_RATE)
	{
		SRCDoneLen = resampler_apply(ResamplerCt1, (int16_t*)iso_dac_buf, (int16_t*)SRCOutBuf11, Len / 4);
		MCUCircular_PutData(&SpeakerCircularBuf, SRCOutBuf11, SRCDoneLen * 2 * 2);
	}
	else
	{
		MCUCircular_PutData(&SpeakerCircularBuf, iso_dac_buf,Len);
	}
#else
	MCUCircular_PutData(&SpeakerCircularBuf, iso_dac_buf,Len);
#endif
#endif
}


void OnDeviceAudioSendIsoPacket(void)// mic data to pc bkd change
{
	uint32_t RealLen;
	uint32_t change_to_st_count=0;
	
	RealLen = AudioADC_DataGet(ADC1_MODULE,iso_adc_buf, 48);//unit：sample
	RealLen *= 4;//转化为Byte

	OTG_DeviceISOSend(DEVICE_ISO_IN_EP,iso_adc_buf,RealLen);
}

#if 1
//声卡Speaker音量控制接口
bool     AudioMuteFlag = FALSE;
bool     AudioMicMuteFlag = FALSE;

uint32_t SpeakerSampleRateGet()
{
#ifdef CFG_FUNC_MIXER_SRC_EN
	return UsbAudioSampleRate;
#else
	return AudioDAC_SampleRateGet(DAC0);
#endif
}

uint32_t SpeakerSampleRateSet(uint32_t SampleRate)
{

	DBG("SampleRate = %ld\n", SampleRate);

#ifdef CFG_FUNC_MIXER_SRC_EN
	UsbAudioSampleRate = SampleRate;
#else
	if((SampleRate == 11025) || (SampleRate == 22050) || (SampleRate == 44100))
	{
		Clock_AudioMclkSel(AUDIO_DAC0, PLL_CLK_1);
	}
	else
	{
		Clock_AudioMclkSel(AUDIO_DAC0, PLL_CLK_2);
	}
    //digital
	AudioDAC_SampleRateSet(ADC0_MODULE, SampleRate);
#endif
	return 0;
}

uint32_t SpeakerMuteGet()
{
	return AudioMuteFlag;
}

uint32_t SpeakerMuteSet(uint32_t Mute)
{
	AudioMuteFlag = Mute;
#ifndef CFG_APP_CONFIG
	AudioDAC_SoftMute(DAC0, AudioMuteFlag, AudioMuteFlag);
#else
	if(AudioMuteFlag)
	{
		AudioCoreSinkMute(0, TRUE, TRUE);
	}
	else
	{
		AudioCoreSinkUnmute(0, TRUE, TRUE);
	}
#endif
	return 0;
}

uint32_t SpeakerLeftVolumeGet()
{
	uint16_t l,r;
	l = 0;
	r = 0;
#ifndef CFG_APP_CONFIG
	AudioDAC_VolGet(DAC0,&l,&r);
#else
	AudioCoreSinkVolGet(0, &l, &r);
#endif
	return l;
}

uint32_t SpeakerRightVolumeGet()
{
	uint16_t l,r;
	l = 0;
	r = 0;
#ifndef CFG_APP_CONFIG
	AudioDAC_VolGet(DAC0,&l,&r);
#else
	AudioCoreSinkVolGet(0, &l, &r);
#endif
	return r;
}

uint32_t SpeakerLeftVolumeSet(uint32_t Vol)
{
	uint16_t l,r;
	l = 0;
	r = 0;
#ifndef CFG_APP_CONFIG
	AudioDAC_VolGet(DAC0,&l,&r);
	l = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	AudioDAC_VolSet(DAC0,l,r);
#else
	AudioCoreSinkVolGet(0, &l, &r);
	l = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	AudioCoreSinkVolSet(0, l, r);
#endif
	return 0;
}

uint32_t SpeakerRigthVolumeSet(uint32_t Vol)
{
	uint16_t l,r;
	l = 0;
	r = 0;
#ifndef CFG_APP_CONFIG
	AudioDAC_VolGet(DAC0,&l,&r);
	r = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	AudioDAC_VolSet(DAC0,l,r);
#else
	AudioCoreSinkVolGet(0, &l, &r);
	r = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	AudioCoreSinkVolSet(0, l, r);
#endif
	return 0;
}

uint32_t MicSampleRateGet()
{
#ifdef CFG_FUNC_MIXER_SRC_EN
	return UsbAudioMicSampleRate;
#else
	return AudioADC_SampleRateGet(AUDIO_ADC1);
#endif
}

uint32_t MicSampleRateSet(uint32_t SampleRate)
{
#ifdef CFG_FUNC_MIXER_SRC_EN
	UsbAudioMicSampleRate = SampleRate;
#else
	if((SampleRate == 11025) || (SampleRate == 22050) || (SampleRate == 44100))
	{
		Clock_AudioMclkSel(AUDIO_ADC1, PLL_CLK_1);
	}
	else
	{
		Clock_AudioMclkSel(AUDIO_ADC1, PLL_CLK_2);
	}
	AudioADC_SampleRateSet(AUDIO_ADC1, SampleRate);
#endif
	return 0;
}

uint32_t MicMuteGet()
{
	return AudioMicMuteFlag;
}

uint32_t MicMuteSet(uint32_t mute)
{
	AudioMicMuteFlag = mute;
#ifndef CFG_APP_CONFIG
	AudioADC_SoftMute(AUDIO_ADC1, mute, mute);
#else
	if(AudioMicMuteFlag)
	{
		//AudioCoreSourceMute(UsbAudioSourceNum(), TRUE, TRUE);
		AudioCoreSourceMute(0, TRUE, TRUE);//ADC mic使用 source 0
	}
	else
	{
		//AudioCoreSourceUnmute(UsbAudioSourceNum(), TRUE, TRUE);
		AudioCoreSourceUnmute(0, TRUE, TRUE);//ADC mic使用 source 0
	}
#endif
	return 0;
}

uint32_t MicLeftVolumeGet()
{
	uint16_t l,r;
	l=0;
	r=0;
#ifndef CFG_APP_CONFIG
	AudioADC_VolGet(AUDIO_ADC1,&l,&r);
#else
	//AudioCoreSourceVolGet(UsbAudioSourceNum(), &l, &r);
	AudioCoreSourceVolGet(0, &l, &r);//ADC mic使用 source 0
#endif
	return l;
}

uint32_t MicLeftVolumeSet(uint32_t Vol)
{
#ifndef CFG_APP_CONFIG
	AudioADC_VolSetChannel(AUDIO_ADC1,CHANNEL_LEFT,(Vol*0xFFF)/AUDIO_MAX_VOLUME);
#else
	uint16_t l,r;
	l = 0;
	r = 0;
	//AudioCoreSourceVolGet(UsbAudioSourceNum(), &l, &r);
	AudioCoreSourceVolGet(0, &l, &r);//ADC mic使用 source 0
	l = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	//AudioCoreSourceVolSet(UsbAudioSourceNum(), l, r);
	AudioCoreSourceVolSet(0, l, r);//ADC mic使用 source 0
#endif
	return 0;
}

uint32_t MicRightVolumeGet()
{
	uint16_t l,r;
	l=0;
	r=0;
#ifndef CFG_APP_CONFIG
	AudioADC_VolGet(AUDIO_ADC1,&l,&r);
#else
	//AudioCoreSourceVolGet(UsbAudioSourceNum(), &l, &r);
	AudioCoreSourceVolGet(0, &l, &r);//ADC mic使用 source 0
#endif
	return r;
}

uint32_t MicRigthVolumeSet(uint32_t Vol)
{
#ifndef CFG_APP_CONFIG
	AudioADC_VolSetChannel(AUDIO_ADC1,CHANNEL_RIGHT,(Vol*0xFFF)/AUDIO_MAX_VOLUME);
#else
	uint16_t l,r;
	l = 0;
	r = 0;
	//AudioCoreSourceVolGet(UsbAudioSourceNum(), &l, &r);
	AudioCoreSourceVolGet(0, &l, &r);//ADC mic使用 source 0
	r = (Vol*0xFFF)/AUDIO_MAX_VOLUME;
	//AudioCoreSourceVolSet(UsbAudioSourceNum(), l, r);
	AudioCoreSourceVolSet(0, l, r);//ADC mic使用 source 0
#endif
	return 0;
}
#endif

void OTG_DeviceAudioInit()
{
	UsbAudioSpeaker.FuncLeftVolSet = SpeakerLeftVolumeSet;
	UsbAudioSpeaker.FuncLeftVolGet = SpeakerLeftVolumeGet;
	UsbAudioSpeaker.FuncRightVolSet = SpeakerRigthVolumeSet;
	UsbAudioSpeaker.FuncRightVolGet = SpeakerRightVolumeGet;
	UsbAudioSpeaker.FuncMuteGet = SpeakerMuteGet;
	UsbAudioSpeaker.FuncMuteSet = SpeakerMuteSet;
	UsbAudioSpeaker.FuncSampleRateGet = SpeakerSampleRateGet;
	UsbAudioSpeaker.FuncSampleRateSet = SpeakerSampleRateSet;

	UsbAudioMic.FuncLeftVolSet = MicLeftVolumeSet;
	UsbAudioMic.FuncLeftVolGet = MicLeftVolumeGet;
	UsbAudioMic.FuncRightVolSet = MicRigthVolumeSet;
	UsbAudioMic.FuncRightVolGet = MicRightVolumeGet;
	UsbAudioMic.FuncMuteGet = MicMuteGet;
	UsbAudioMic.FuncMuteSet = MicMuteSet;
	UsbAudioMic.FuncSampleRateGet = MicSampleRateGet;
	UsbAudioMic.FuncSampleRateSet = MicSampleRateSet;

	UsbAudioSpeaker.AltSet = 0;
	//UsbAudioSpeaker.FuncLeftVolSet(AUDIO_MAX_VOLUME / 10);
	//UsbAudioSpeaker.FuncRightVolSet(AUDIO_MAX_VOLUME / 10);
	UsbAudioSpeaker.FuncMuteSet(0);
	UsbAudioSpeaker.FuncSampleRateSet(44100);

	UsbAudioMic.AltSet = 0;
	UsbAudioMic.FuncLeftVolSet(AUDIO_MAX_VOLUME);
	UsbAudioMic.FuncRightVolSet(AUDIO_MAX_VOLUME);
	UsbAudioMic.FuncMuteSet(0);
	UsbAudioMic.FuncSampleRateSet(44100);
}

void OTG_DeviceAudioRequest(void)
{
	//AUDIO控制接口组件ID号定义（必须与device_stor_audio_request.c中的定义保持一致！）
	#define AUDIO_SPEAKER_IT_ID		1
	#define AUDIO_SPEAKER_FU_ID		2	//控制MUTE、VOLUME
	#define AUDIO_SPEAKER_OT_ID		3
	#define AUDIO_MIC_IT_ID			4
	#define AUDIO_MIC_FU_ID			5
	#define AUDIO_MIC_SL_ID			6
	#define AUDIO_MIC_OT_ID			7
	
	#define AudioCmd	((Setup[0] << 8) | Setup[1])
	#define Channel		Setup[2]
	#define Control		Setup[3]
	#define Entity		Setup[5]
	
	#define SET_CUR		0x2101
	#define SET_IDLE	0x210A
	#define GET_CUR		0xA181
	#define GET_MIN		0xA182
	#define GET_MAX		0xA183
	#define GET_RES		0xA184
	
	#define SET_CUR_EP	0x2201
	#define GET_CUR_EP	0xA281
	
	//AUDIO类请求处理
	if(AudioCmd == SET_CUR_EP)
	{
		//_DBG("Set samplerate\n");
		if(Setup[4] == 0x84)
		{
			UsbAudioMic.FuncSampleRateSet(Request[1]*256 + Request[0]);
		}
		else
		{
			UsbAudioSpeaker.FuncSampleRateSet(Request[1]*256 + Request[0]);//bkd find set sample
		}
		return;
	}
	if(AudioCmd == GET_CUR_EP)
	{
		uint32_t Temp = 0;
	//	OTG_DBG("Get samplerate\n");
		if(Setup[4] == 0x84)
		{
			Temp = UsbAudioMic.FuncSampleRateGet();
		}
		else
		{
			Temp =UsbAudioSpeaker.FuncSampleRateGet();
		}
		Setup[0] = (Temp>>0 ) & 0x000000FF;
		Setup[1] = (Temp>>8 ) & 0x000000FF;
		Setup[2] = (Temp>>16) & 0x000000FF;
		OTG_DeviceControlSend(Setup,3,3);
		return;
	}

	if((Entity == AUDIO_SPEAKER_FU_ID) && (Control == 0x01))
	{
		//Speaker mute的操作
		if(AudioCmd == GET_CUR)
		{
			Setup[0] = UsbAudioSpeaker.FuncMuteGet();
			OTG_DeviceControlSend(Setup,1,3);
		}
		else if(AudioCmd == SET_CUR)
		{
			//OTG_DBG("Set speaker mute: %d\n", Request[0]);
			UsbAudioSpeaker.FuncMuteSet(Request[0]);
		}
		else
		{
			//OTG_DBG("%s %d\n",__FILE__,__LINE__);
		}
	}
	else if((Entity == AUDIO_SPEAKER_FU_ID) && (Control == 0x02))
	{
		//Speaker volume的操作
		if(AudioCmd == GET_MIN)
		{
			//OTG_DBG("Get speaker min volume\n");
			OTG_DeviceSendResp(0x0000, 2);
		}
		else if(AudioCmd == GET_MAX)
		{
			//OTG_DBG("Get speaker max volume\n");
			OTG_DeviceSendResp(AUDIO_MAX_VOLUME, 2);
		}
		else if(AudioCmd == GET_RES)
		{
			//OTG_DBG("Get speaker res volume\n");
			OTG_DeviceSendResp(0x0001, 2);
		}
		else if(AudioCmd == GET_CUR)
		{
			uint32_t Vol = 0;
			if(Channel == 0x01)
			{
				Vol = UsbAudioSpeaker.FuncLeftVolGet();
			}
			else
			{
				Vol = UsbAudioSpeaker.FuncRightVolGet();
			}
			OTG_DeviceSendResp(Vol, 2);
		}
		else if(AudioCmd == SET_CUR)
		{
			uint32_t Temp = 0;
			Temp = (Request[1] & 0x7F) * 256 + Request[0];
			if(Setup[2] == 0x01)
			{
				UsbAudioSpeaker.FuncLeftVolSet(Temp);
			}
			else
			{
				UsbAudioSpeaker.FuncRightVolSet(Temp);
			}
		}
		else
		{
			//OTG_DBG("%s %d\n",__FILE__,__LINE__);
		}
	}
	else if((Entity == AUDIO_MIC_FU_ID) && (Control == 0x01))
	{
		//Mic mute的操作
		if(AudioCmd == GET_CUR)
		{
			uint32_t AudioMicMuteFlag;
			AudioMicMuteFlag = UsbAudioMic.FuncMuteGet();
			OTG_DeviceSendResp(AudioMicMuteFlag, 1);
			//OTG_DBG("Get mic mute: %d\n", (int)AudioMicMuteFlag);
		}
		else if(AudioCmd == SET_CUR)
		{
			//OTG_DBG("Set mic mute: %d\n", Request[0]);
			UsbAudioMic.FuncLeftVolSet(Request[0]);
		}
		else
		{
			//OTG_DBG("%s %d\n",__FILE__,__LINE__);
		}
	}
	else if((Entity == AUDIO_MIC_FU_ID) && (Control == 0x02))
	{
		//Mic volume的操作
		if(AudioCmd == GET_MIN)
		{
			//OTG_DBG("Get mic min volume\n");
			OTG_DeviceSendResp(0x0000, 2);
		}
		else if(AudioCmd == GET_MAX)
		{
			//OTG_DBG("Get mic max volume\n");
			OTG_DeviceSendResp(AUDIO_MAX_VOLUME*4, 2);	//此处乘以4的原因请看本文件开头的注释说明
		}
		else if(AudioCmd == GET_RES)
		{
			//OTG_DBG("Get mic res volume\n");
			OTG_DeviceSendResp(0x0001, 2);
		}
		else if(AudioCmd == GET_CUR)
		{
			uint32_t Vol = 0;
			if(Channel == 0x01)
			{
				Vol = UsbAudioMic.FuncLeftVolGet();
			}
			else
			{
				Vol = UsbAudioMic.FuncRightVolGet();
			}
			OTG_DeviceSendResp(Vol*4, 2);
		}
		else if(AudioCmd == SET_CUR)
		{
			uint32_t Vol = ((Request[1] & 0x7F) * 256 + Request[0])/4;
			if(Setup[2] == 0x01)
			{
				UsbAudioMic.FuncLeftVolSet(Vol);
			}
			else
			{
				UsbAudioMic.FuncRightVolSet(Vol);
			}
		}
		else
		{
			//OTG_DBG("%s %d\n",__FILE__,__LINE__);
		}
	}
	else if(Entity == AUDIO_MIC_SL_ID)
	{
		//Selector的操作
		if(AudioCmd == GET_CUR)
		{
			//OTG_DBG("Get selector: 1\n");
			OTG_DeviceSendResp(0x01, 1);
		}
		else
		{
			//OTG_DBG("%s %d\n",__FILE__,__LINE__);
		}
	}
	else if(AudioCmd == SET_IDLE)
	{
		//OTG_DBG("Set idle\n");
	}	
	else
	{
		//其他AUDIO类的输入请求
		//OTG_DBG("Unkown command! %02X %02X %02X %02X %02X %02X %02X %02X\n", Setup[0], Setup[1], Setup[2], Setup[3], Setup[4], Setup[5], Setup[6], Setup[7]);
		OTG_DeviceSendResp(0x0000, 1);
	}
}

#endif
